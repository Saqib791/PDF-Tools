<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invert Your PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Base and Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Body and Layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            font-size: clamp(1.8em, 5vw, 3em);
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        .branding {
            text-align: center;
            color: #764ba2;
            margin-bottom: 25px;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            font-weight: 600;
            opacity: 0.8;
        }

        /* --- Control Bar Section --- */
        .controls-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .controls-toggle:active {
            transform: scale(0.98);
        }

        .controls-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0 10px;
            text-align: center;
        }

        .controls-content.show {
            max-height: 500px; /* Large enough for content */
            padding-bottom: 15px;
            transition: max-height 0.6s ease-in, padding 0.6s ease-in;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 18px 45px;
            border: none;
            border-radius: 50px;
            font-size: clamp(1em, 3vw, 1.2em);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-btn:active {
            transform: scale(0.95);
        }
        
        #fileInput {
            display: none;
        }

        /* Color Picker Styling */
        .color-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 1px solid #f0f0f0;
            border-radius: 15px;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .color-options .color-picker-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .color-options label {
            font-weight: 600;
            color: #333;
            font-size: clamp(1em, 2.5vw, 1.1em);
        }

        #invertColorPicker {
            width: 50px;
            height: 30px;
            padding: 0;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        /* Status */
        .status {
            text-align: center;
            color: #666;
            margin: 10px 0;
            font-size: clamp(0.9em, 2.5vw, 1em);
            font-weight: 500;
            padding: 12px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            display: inline-block;
            width: auto;
            max-width: 100%;
        }
        
        .status-container {
            text-align: center;
            margin: 15px 0;
        }
        
        /* --- Pages View: Responsive Grid Layout --- */
        
        /* Removed .pages-scroll-container, Pages are now in a regular flow */
        
        .pages-container {
            /* Default grid for all screen sizes (mobile first) */
            display: grid;
            /* Auto-fit as many columns as possible, with each being at least 280px wide */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px 0; /* Vertical spacing for the grid */
            justify-items: center; /* Center items if they don't fill the container */
        }
        
        .page-item {
            width: 100%; /* Take full width of its grid column */
            max-width: 400px; /* Optional: Keep individual pages from getting too wide on huge screens */
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .page-item:active {
            transform: scale(0.98);
        }
        
        .page-item canvas {
            width: 100%;
            height: auto;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .page-number {
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        
        .invert-btn, .delete-btn {
            border: none;
            padding: 14px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }
        
        .invert-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .invert-btn:active {
            transform: scale(0.95);
        }
        
        .invert-btn:not(.inverted) {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
            box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
        }
        
        .delete-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }
        
        .delete-btn:active {
            transform: scale(0.95);
        }
        
        /* Download Section */
        .download-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            font-size: clamp(1.1em, 3vw, 1.3em);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            display: none;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }
        
        .download-btn.show {
            display: inline-flex;
        }
        
        .download-btn:active {
            transform: scale(0.95);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            grid-column: 1 / -1; /* Make empty state span the full width */
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* PC / Tablet Optimizations (Min-width 769px) */
        @media (min-width: 769px) {
            .controls-toggle {
                display: none; /* Hide the toggle button on larger screens */
            }
            
            .controls-content {
                max-height: none; /* Always show controls */
                overflow: visible;
                padding: 0 0 25px 0;
            }

            .color-options {
                flex-direction: row; /* Layout controls side-by-side */
                justify-content: center;
                gap: 25px;
            }

            .download-btn {
                background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); /* Use the green download color */
                box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Invert Your PDF</h1>
        <div class="branding">Made by Saqib</div>
        
        <div class="controls-toggle" onclick="document.getElementById('controlsContent').classList.toggle('show');">
            ‚öôÔ∏è Show/Hide Options
        </div>

        <div class="controls-content show" id="controlsContent">
            
            <div class="upload-section">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    üìÑ Upload PDF
                </button>
                <input type="file" id="fileInput" accept=".pdf">
            </div>

            <div class="color-options">
                <div class="color-picker-group">
                    <label for="invertColorPicker">Choose Dark Mode Color:</label>
                    <input type="color" id="invertColorPicker" value="#1a1a1a">
                </div>
                <p style="font-size: 0.9em; color: #777;">(This color will replace white/light backgrounds after inversion)</p>
            </div>
        </div>
        
        <div class="status-container">
            <div class="status" id="status">Upload a PDF to get started</div>
        </div>
        
        <div class="pages-container" id="pagesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üìë</div>
                <p>No PDF loaded yet</p>
            </div>
        </div>
        <div class="download-section">
            <button class="download-btn" id="downloadBtn">‚¨áÔ∏è Download PDF</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let pdfDoc = null;
        let pageStates = [];
        let originalSizes = [];
        let originalFileName = '';
        let deletedPages = [];
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
        
        // --- Utility function to convert Hex color to RGB object ---
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return { r, g, b };
        }

        // Removed the unnecessary drag/swipe scroll logic since we are using a grid.
        
        // Initial setup for controls visibility on larger screens
        if (window.innerWidth >= 769) {
            document.getElementById('controlsContent').classList.add('show');
        }

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            originalFileName = file.name.replace('.pdf', '');
            
            document.getElementById('status').textContent = 'Loading PDF...';
            document.getElementById('pagesContainer').innerHTML = ''; // Clear existing pages
            document.getElementById('downloadBtn').classList.remove('show');
            
            // Removed scrollIndicator logic
            
            const arrayBuffer = await file.arrayBuffer();
            pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            pageStates = new Array(pdfDoc.numPages).fill(true);
            deletedPages = new Array(pdfDoc.numPages).fill(false);
            originalSizes = [];
            
            document.getElementById('status').textContent = `${pdfDoc.numPages} pages loaded - All set to invert`;
            
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                await renderPage(i);
            }
            
            document.getElementById('downloadBtn').classList.add('show');
        }
        
        async function renderPage(pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            originalSizes[pageNum - 1] = {
                width: page.view[2] - page.view[0],
                height: page.view[3] - page.view[1]
            };
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
            
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page-item';
            pageDiv.id = `page-${pageNum}`;
            pageDiv.innerHTML = `
                <div class="page-number">Page ${pageNum}</div>
                <div class="button-group">
                    <button class="invert-btn inverted" onclick="toggleInvert(${pageNum})">
                        <span>‚úì</span> Will Invert
                    </button>
                    <button class="delete-btn" onclick="deletePage(${pageNum})">
                        <span>üóëÔ∏è</span> Delete Page
                    </button>
                </div>
            `;
            pageDiv.insertBefore(canvas, pageDiv.querySelector('.page-number'));
            
            document.getElementById('pagesContainer').appendChild(pageDiv);
        }
        
        function toggleInvert(pageNum) {
            pageStates[pageNum - 1] = !pageStates[pageNum - 1];
            const pageDiv = document.getElementById(`page-${pageNum}`);
            const btn = pageDiv.querySelector('.invert-btn');
            
            if (pageStates[pageNum - 1]) {
                btn.innerHTML = '<span>‚úì</span> Will Invert';
                btn.classList.add('inverted');
            } else {
                btn.innerHTML = '<span>‚ùå</span> Skip Invert';
                btn.classList.remove('inverted');
            }
        }
        
        function deletePage(pageNum) {
            deletedPages[pageNum - 1] = true;
            const pageDiv = document.getElementById(`page-${pageNum}`);
            pageDiv.style.transform = 'scale(0)';
            pageDiv.style.opacity = '0';
            
            setTimeout(() => {
                pageDiv.style.display = 'none';
                const remainingPages = deletedPages.filter(d => !d).length;
                document.getElementById('status').textContent = `${remainingPages} page${remainingPages !== 1 ? 's' : ''} remaining`;
            }, 300);
        }
        
        async function downloadPDF() {
            document.getElementById('status').textContent = 'Generating PDF...';
            document.getElementById('downloadBtn').textContent = '‚è≥ Processing...';
            
            // Get the user's chosen color for the dark background
            const chosenHexColor = document.getElementById('invertColorPicker').value;
            const chosenRgb = hexToRgb(chosenHexColor);
            
            const { jsPDF } = window.jspdf;
            let pdf = null;
            let firstPage = true;
            
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                if (deletedPages[i - 1]) continue;
                
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 2 });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({
                    canvasContext: ctx,
                    viewport: viewport
                }).promise;
                
                if (pageStates[i - 1]) {
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imgData.data;
                    
                    for (let j = 0; j < data.length; j += 4) {
                        // 1. Calculate Grayscale Luminosity
                        const r = data[j];
                        const g = data[j + 1];
                        const b = data[j + 2];
                        // Standard luminance formula (used for perception)
                        const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b); 
                        
                        // 2. Perform Inversion on Luminosity
                        const invertedLum = 255 - lum;
                        
                        // 3. Map Inverted Luminosity to the Chosen Color
                        const scale = 1 - (invertedLum / 255); 
                        
                        // Calculate the new color by blending the chosen color and white based on the inverted luminosity
                        data[j] = Math.round(chosenRgb.r * scale + 255 * (1 - scale));
                        data[j + 1] = Math.round(chosenRgb.g * scale + 255 * (1 - scale));
                        data[j + 2] = Math.round(chosenRgb.b * scale + 255 * (1 - scale));
                    }
                    
                    ctx.putImageData(imgData, 0, 0);
                }
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                
                const origWidth = originalSizes[i - 1].width * 0.75;
                const origHeight = originalSizes[i - 1].height * 0.75;
                
                if (firstPage) {
                    pdf = new jsPDF({
                        orientation: origWidth > origHeight ? 'landscape' : 'portrait',
                        unit: 'pt',
                        format: [origWidth, origHeight]
                    });
                    firstPage = false;
                } else {
                    pdf.addPage([origWidth, origHeight], origWidth > origHeight ? 'landscape' : 'portrait');
                }
                
                pdf.addImage(imgData, 'JPEG', 0, 0, origWidth, origHeight);
            }
            
            pdf.save(originalFileName + '_inverted_custom.pdf');
            document.getElementById('status').textContent = '‚úÖ PDF downloaded successfully!';
            document.getElementById('downloadBtn').innerHTML = '‚¨áÔ∏è Download PDF';
        }
    </script>
</body>
</html>